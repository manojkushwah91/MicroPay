version: '3.8'

services:
  # Zookeeper Service
  # Zookeeper is required for Kafka to manage cluster metadata, leader election, and configuration
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: zookeeper
    hostname: zookeeper
    ports:
      - "2181:2181"
    environment:
      # Zookeeper client port
      ZOOKEEPER_CLIENT_PORT: 2181
      # Tick time in milliseconds (used for session timeout calculations)
      ZOOKEEPER_TICK_TIME: 2000
      # Transaction log directory
      ZOOKEEPER_DATA_DIR: /var/lib/zookeeper/data
      # Transaction log directory
      ZOOKEEPER_LOG_DIR: /var/lib/zookeeper/log
      # Maximum number of client connections
      ZOOKEEPER_MAX_CLIENT_CNXNS: 60
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log
    networks:
      - micropay-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # Kafka Broker Service
  # Kafka broker handles message storage, replication, and consumer/producer requests
  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka
    hostname: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      # Kafka broker ID (must be unique in cluster)
      KAFKA_BROKER_ID: 1
      # Zookeeper connection string
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # Listener configuration for internal and external connections
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      # Internal listener (for inter-broker communication)
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:29092
      # Listener protocol mapping
      KAFKA_LISTENERS: PLAINTEXT://:9092,PLAINTEXT_INTERNAL://:29092
      # Inter-broker listener name
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
      # Disable automatic topic creation (topics must be created explicitly)
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
      # Number of partitions for auto-created topics (if enabled)
      KAFKA_NUM_PARTITIONS: 3
      # Default replication factor for auto-created topics (if enabled)
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      # Log retention time in hours (7 days)
      KAFKA_LOG_RETENTION_HOURS: 168
      # Log retention size in bytes (unlimited)
      KAFKA_LOG_RETENTION_BYTES: -1
      # Log segment size (1GB)
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      # Compression type (snappy for better performance)
      KAFKA_COMPRESSION_TYPE: snappy
      # Transaction state log replication factor
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      # Transaction state log min in-sync replicas
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      # Enable transaction id expiration
      KAFKA_TRANSACTION_STATE_LOG_SEGMENT_BYTES: 104857600
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - micropay-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Kafka Topics Initialization Service
  # This service creates all required Kafka topics on startup
  kafka-init:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - micropay-network
    entrypoint: ["/bin/sh", "-c"]
    command: |
      echo "Waiting for Kafka to be ready..."
      # Wait for Kafka to be ready (max 60 seconds)
      for i in $$(seq 1 60); do
        if kafka-broker-api-versions --bootstrap-server kafka:29092 > /dev/null 2>&1; then
          echo "Kafka is ready!"
          break
        fi
        echo "Waiting for Kafka... ($$i/60)"
        sleep 1
      done
      
      echo "Creating Kafka topics..."
      
      # User domain topics
      kafka-topics --create --if-not-exists \
        --bootstrap-server kafka:29092 \
        --topic user.created \
        --partitions 3 \
        --replication-factor 1 \
        --config retention.ms=604800000 \
        --config cleanup.policy=delete
      
      # Wallet domain topics
      kafka-topics --create --if-not-exists \
        --bootstrap-server kafka:29092 \
        --topic wallet.created \
        --partitions 3 \
        --replication-factor 1 \
        --config retention.ms=604800000 \
        --config cleanup.policy=delete
      
      kafka-topics --create --if-not-exists \
        --bootstrap-server kafka:29092 \
        --topic wallet.balance.updated \
        --partitions 3 \
        --replication-factor 1 \
        --config retention.ms=604800000 \
        --config cleanup.policy=delete
      
      # Payment domain topics
      kafka-topics --create --if-not-exists \
        --bootstrap-server kafka:29092 \
        --topic payment.initiated \
        --partitions 3 \
        --replication-factor 1 \
        --config retention.ms=604800000 \
        --config cleanup.policy=delete
      
      kafka-topics --create --if-not-exists \
        --bootstrap-server kafka:29092 \
        --topic payment.authorized \
        --partitions 3 \
        --replication-factor 1 \
        --config retention.ms=604800000 \
        --config cleanup.policy=delete
      
      kafka-topics --create --if-not-exists \
        --bootstrap-server kafka:29092 \
        --topic payment.completed \
        --partitions 3 \
        --replication-factor 1 \
        --config retention.ms=604800000 \
        --config cleanup.policy=delete
      
      kafka-topics --create --if-not-exists \
        --bootstrap-server kafka:29092 \
        --topic payment.failed \
        --partitions 3 \
        --replication-factor 1 \
        --config retention.ms=604800000 \
        --config cleanup.policy=delete
      
      # Transaction domain topics
      kafka-topics --create --if-not-exists \
        --bootstrap-server kafka:29092 \
        --topic transaction.recorded \
        --partitions 3 \
        --replication-factor 1 \
        --config retention.ms=604800000 \
        --config cleanup.policy=delete
      
      # Notification domain topics
      kafka-topics --create --if-not-exists \
        --bootstrap-server kafka:29092 \
        --topic notification.send \
        --partitions 3 \
        --replication-factor 1 \
        --config retention.ms=86400000 \
        --config cleanup.policy=delete
      
      echo "All topics created successfully!"
      echo "Listing all topics:"
      kafka-topics --list --bootstrap-server kafka:29092
    restart: "no"

# Docker Networks
# Network for inter-container communication
networks:
  micropay-network:
    driver: bridge
    name: micropay-network

# Docker Volumes
# Persistent storage for Zookeeper and Kafka data
volumes:
  # Zookeeper data volume
  zookeeper-data:
    driver: local
    name: micropay-zookeeper-data
  # Zookeeper logs volume
  zookeeper-logs:
    driver: local
    name: micropay-zookeeper-logs
  # Kafka data volume
  kafka-data:
    driver: local
    name: micropay-kafka-data

